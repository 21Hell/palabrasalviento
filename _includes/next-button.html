{% comment %} Compute separate next/previous items for poemas and peliculas, and a previous item for the current page's collection. {% endcomment %}
{% assign next_item = nil %}
{% assign next_poema = nil %}
{% assign prev_poema = nil %}
{% assign next_pelicula = nil %}
{% assign prev_pelicula = nil %}
{% assign prev_item = nil %}

{%- comment -%}
  Don't show on the homepage (root). Handle cases where site.baseurl is set.
{%- endcomment -%}
{%- assign home_urls = '/' | split: ',' -%}
{%- assign base = site.baseurl | default: '' -%}
{%- if base != '' -%}
  {%- assign home_urls = home_urls | push: base -%}
  {%- assign home_urls = home_urls | push: base | append: '/' -%}
{%- endif -%}
{%- for h in home_urls -%}
  {%- if page.url == h -%}
    {%- assign next_item = nil -%}
    {%- break -%}
  {%- endif -%}
{%- endfor -%}

{%- comment -%} Next & prev for poemas (always show poema buttons if collection exists) {%- endcomment -%}
{%- comment -%}
  Poemas navigation will be computed later (inside the poemas branch) using Roman numeral order.
{%- endcomment -%}

{%- comment -%} keep searching for a generic next_item if not defined, using posts as fallback {%- endcomment -%}
{% if next_item == nil and site.posts and site.posts.size > 0 %}
  {% assign found = false %}
  {% for item in site.posts %}
    {% if found and next_item == nil %}
      {% assign next_item = item %}
    {% endif %}
  {% if item.url | relative_url == page.url | relative_url %}
      {% assign found = true %}
    {% endif %}
  {% endfor %}
  {% if next_item == nil %}
    {% assign next_item = site.posts | first %}
  {% endif %}
{% endif %}

{%- comment -%} Next & prev for peliculas {%- endcomment -%}
{% if site.peliculas and site.peliculas.size > 0 %}
  {% assign found = false %}
  {% for item in site.peliculas %}
    {% if found and next_pelicula == nil %}
      {% assign next_pelicula = item %}
    {% endif %}
  {% if item.url | relative_url == page.url | relative_url %}
      {% assign found = true %}
    {% endif %}
  {% endfor %}
  {% if next_pelicula == nil %}
    {% assign next_pelicula = site.peliculas | first %}
  {% endif %}

  {% assign last_seen = nil %}
  {% for item in site.peliculas %}
  {% if item.url | relative_url == page.url | relative_url %}
      {% if last_seen %}
        {% assign prev_pelicula = last_seen %}
      {% else %}
        {% assign prev_pelicula = site.peliculas | last %}
      {% endif %}
      {% break %}
    {% endif %}
    {% assign last_seen = item %}
  {% endfor %}
  {% if prev_pelicula == nil %}
    {% assign prev_pelicula = site.peliculas | last %}
  {% endif %}
{% endif %}

{%- comment -%} Render buttons: Previous (for current collection), Next Poema, Next Pelicula {%- endcomment -%}
{%- comment -%} Compute prev_item for the current page by checking each collection in order: poemas, posts, peliculas {%- endcomment -%}
{% if site.poemas and site.poemas.size > 0 %}
  {% assign last_seen = nil %}
  {% for item in site.poemas %}
  {% if item.url | relative_url == page.url | relative_url %}
      {% if last_seen %}
        {% assign prev_item = last_seen %}
      {% else %}
        {% assign prev_item = site.poemas | last %}
      {% endif %}
      {% break %}
    {% endif %}
    {% assign last_seen = item %}
  {% endfor %}
{% endif %}
{% if prev_item == nil and site.posts and site.posts.size > 0 %}
  {% assign last_seen = nil %}
  {% for item in site.posts %}
  {% if item.url | relative_url == page.url | relative_url %}
      {% if last_seen %}
        {% assign prev_item = last_seen %}
      {% else %}
        {% assign prev_item = site.posts | last %}
      {% endif %}
      {% break %}
    {% endif %}
    {% assign last_seen = item %}
  {% endfor %}
{% endif %}
{% if prev_item == nil and site.peliculas and site.peliculas.size > 0 %}
  {% assign last_seen = nil %}
  {% for item in site.peliculas %}
  {% if item.url | relative_url == page.url | relative_url %}
      {% if last_seen %}
        {% assign prev_item = last_seen %}
      {% else %}
        {% assign prev_item = site.peliculas | last %}
      {% endif %}
      {% break %}
    {% endif %}
    {% assign last_seen = item %}
  {% endfor %}
{% endif %}

{%- comment -%} Render navigation only when viewing an individual poema or pelicula page. Place the nav inside the card (not fixed). {%- endcomment -%}

{%- if page.collection == 'poemas' -%}
  {%- comment -%}
    Compute next/prev poem using Roman numerals order based on the title.
    Build a compact ordered list of existing numerals and their urls, then find the index
    of the current page in that compact list. This is less error-prone than per-iteration
    url comparisons and avoids baseurl mismatches.
  {%- endcomment -%}
  {% assign roman_order_str = "I,II,III,IV,V,VI,VII,VIII,IX,X,XI,XII,XIII,XIV,XV,XVI,XVII,XVIII,XIX,XX,XXI,XXII,XXIII,XXIV,XXV,XXVI,XXVII,XXVIII,XXIX,XXX,XXXI,XXXII,XXXIII,XXXIV,XXXV,XXXVI,XXXVII,XXXVIII,XXXIX,XL,XLI,XLII,XLIII,XLIV,XLV,XLVI,XLVII,XLVIII,XLIX,L,LI,LII,LIII,LIV,LV,LVI,LVII,LVIII,LIX,LX,LXI,LXII,LXIII,LXIV,LXV,LXVI,LXVII,LXVIII,LXIX,LXX,LXXI,LXXII,LXXIII,LXXIV,LXXV,LXXVI,LXXVII,LXXVIII,LXXIX,LXXX,LXXXI,LXXXII,LXXXIII,LXXXIV,LXXXV,LXXXVI,LXXXVII,LXXXVIII,LXXXIX,XC,XCI,XCII,XCIII,XCIV,XCV,XCVI,XCVII,XCVIII,XCIX,C,CI,CII" %}
  {% assign roman_order = roman_order_str | split: ',' %}

  {% assign found_titles = "" | split: "," %}
  {% assign found_urls = "" | split: "," %}

  {%- comment -%} Build compact ordered lists of titles and urls that exist in site.poemas {%- endcomment -%}
  {% for rn in roman_order %}
    {% for p in site.poemas %}
      {% if p.title == rn %}
        {% assign found_titles = found_titles | push: rn %}
        {% assign found_urls = found_urls | push: p.url %}
        {% break %}
      {% endif %}
    {% endfor %}
  {% endfor %}

  {% comment %} Find current index in the compact list (compare urls normalized) {% endcomment %}
  {% assign current_index = -1 %}
  {% for i in (0..found_urls.size) %}
    {% assign u = found_urls[i] %}
    {% if u %}
      {% assign u_rel = u | relative_url %}
      {% assign p_rel = page.url | relative_url %}
      {% if u_rel == p_rel %}
        {% assign current_index = i %}
        {% break %}
      {% endif %}
    {% endif %}
  {% endfor %}

  {% assign prev_poema = nil %}
  {% assign next_poema = nil %}
  {% if current_index != -1 %}
    {% assign n = found_urls.size | minus: 1 %}
    {% assign prev_index = current_index | minus: 1 %}
    {% if prev_index < 0 %}
      {% assign prev_index = n %}
    {% endif %}
    {% assign next_index = current_index | plus: 1 %}
    {% if next_index > n %}
      {% assign next_index = 0 %}
    {% endif %}
    {% assign prev_url = found_urls[prev_index] %}
    {% assign next_url = found_urls[next_index] %}
    {% for p in site.poemas %}
      {% if p.url == prev_url %}
        {% assign prev_poema = p %}
      {% endif %}
      {% if p.url == next_url %}
        {% assign next_poema = p %}
      {% endif %}
    {% endfor %}
  {% endif %}

  <style>
    .in-card-nav{ display:flex; gap:0.6rem; justify-content:flex-end; margin-top:1.5rem; }
    .in-card-nav .next-button{ display:inline-block; background:#111; color:#fff; padding:0.45rem 0.7rem; border-radius:8px; text-decoration:none; font-weight:600; box-shadow:0 6px 18px rgba(0,0,0,0.12); font-family:inherit; }
    .in-card-nav .next-button small{ display:block; font-size:0.7rem; color:#ddd; }
    .in-card-nav .next-button--prev{ background:#fff; color:#111; border:1px solid #ddd; }
  </style>

  <div class="in-card-nav">
    {% if prev_poema %}
      <a class="next-button next-button--prev" href="{{ prev_poema.url | relative_url }}" aria-label="Anterior poema: {{ prev_poema.title }}">Anterior Poema: <strong>{{ prev_poema.title }}</strong>
        <small>{% if prev_poema.date %}{% endif %}</small>
      </a>
    {% endif %}
    {% if next_poema %}
      <a class="next-button" href="{{ next_poema.url | relative_url }}" aria-label="Siguiente poema: {{ next_poema.title }}">Siguiente poema: <strong>{{ next_poema.title }}</strong></a>
    {% endif %}
  </div>

  <script>
  document.addEventListener('keydown', function(e) {
    if (e.key === 'ArrowLeft') {
      var prev = document.querySelector('.next-button--prev');
      if (prev) window.location.href = prev.href;
    }
    if (e.key === 'ArrowRight') {
      var next = document.querySelector('.next-button:not(.next-button--prev)');
      if (next) window.location.href = next.href;
    }
  });
  </script>

{%- elsif page.collection == 'peliculas' -%}
  {%- comment -%} compute next and prev for peliculas specifically {%- endcomment -%}
  {% if next_pelicula == nil %}
    {% assign found = false %}
    {% for item in site.peliculas %}
      {% if found and next_pelicula == nil %}
        {% assign next_pelicula = item %}
      {% endif %}
  {% if item.url | relative_url == page.url | relative_url %}
        {% assign found = true %}
      {% endif %}
    {% endfor %}
    {% if next_pelicula == nil %}
      {% assign next_pelicula = site.peliculas | first %}
    {% endif %}
  {% endif %}

  {% if prev_pelicula == nil %}
    {% assign last_seen = nil %}
    {% for item in site.peliculas %}
  {% if item.url | relative_url == page.url | relative_url %}
        {% if last_seen %}
          {% assign prev_pelicula = last_seen %}
        {% else %}
          {% assign prev_pelicula = site.peliculas | last %}
        {% endif %}
        {% break %}
      {% endif %}
      {% assign last_seen = item %}
    {% endfor %}
    {% if prev_pelicula == nil %}
      {% assign prev_pelicula = site.peliculas | last %}
    {% endif %}
  {% endif %}

  <style>
    .in-card-nav{ display:flex; gap:0.6rem; justify-content:flex-end; margin-top:1.5rem; }
    .in-card-nav .next-button{ display:inline-block; background:#111; color:#fff; padding:0.45rem 0.7rem; border-radius:8px; text-decoration:none; font-weight:600; box-shadow:0 6px 18px rgba(0,0,0,0.12); font-family:inherit; }
    .in-card-nav .next-button small{ display:block; font-size:0.7rem; color:#ddd; }
    .in-card-nav .next-button--prev{ background:#fff; color:#111; border:1px solid #ddd; }
  </style>

  <div class="in-card-nav">
    {% if prev_pelicula %}
      <a class="next-button next-button--prev" href="{{ prev_pelicula.url | relative_url }}" aria-label="Anterior película: {{ prev_pelicula.title }}">← Anterior: <strong>{{ prev_pelicula.title }}</strong>
        <small>{% if prev_pelicula.date %}{{ prev_pelicula.date | date: "%Y" }}{% endif %}</small>
      </a>
    {% endif %}
    {% if next_pelicula %}
      <a class="next-button" href="{{ next_pelicula.url | relative_url }}" aria-label="Siguiente película: {{ next_pelicula.title }}">Siguiente película: <strong>{{ next_pelicula.title }}</strong></a>
    {% endif %}
  </div>

{%- else -%}
  {%- comment -%} Not a single-item poema or pelicula page; render nothing. {%- endcomment -%}
{%- endif -%}
